<!DOCTYPE html><html lang="en"><head><title>lib/predicates</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/predicates"><meta name="groc-project-path" content="lib/predicates.coffee"><meta name="groc-github-url" content="https://github.com/sweetpi/pimatic"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><link rel="stylesheet" type="text/css" media="all" href="../assets/customStyle.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sweetpi/pimatic/blob/master/lib/predicates.coffee">lib/predicates.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="predicate-provider">Predicate Provider</h1>

<p>A Predicate Provider provides a predicate for the Rule System. For predicate and rule explenations
take a look at the <a href="rules.html">rules file</a>. A predicate is a string that describes a state. A
predicate is either true or false at a given time. There are special predicates, 
called event-predicates, that represent events. These predicate are just true in the moment a 
special event happen.</p></div></div><div class="code"><div class="wrapper"><span class="nv">__ = </span><span class="nx">require</span><span class="p">(</span><span class="s">&quot;i18n&quot;</span><span class="p">).</span><span class="nx">__</span>
<span class="nv">Q = </span><span class="nx">require</span> <span class="s">&#39;q&#39;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s">&#39;cassert&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="the-predicate-provider">The Predicate Provider</h2>

<p>This is the base class for all predicate provider. </p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">PredicateProvider</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="candecide">canDecide()</h3>

<p>This function should return 'event' or 'state' if the sensor can decide the given predicate.
If the sensor can decide the predicate and it is a event-predicate like 'its 10pm' then
<code>canDecide</code> should return the string <code>'event'</code>
If the provider can decide the predicate and it can be true or false like 'x is present' then 
<code>canDecide</code> should return the string <code>'state'</code>
If the sensor can not decide the given predicate then <code>canDecide</code> should return the boolean 
<code>false</code></p>

<p><strong>params</strong></p>

<ul>
<li><code>preicate</code>: the predicate as string like <code>"its 10pm"</code> </li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">canDecide: </span><span class="nf">(predicate) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;your predicate provider must implement canDecide&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="istrue">isTrue()</h3>

<p>The provider should return boolean <code>true</code> if the predicate is true and boolean <code>false</code> if it is 
false. If the provider can not decide the predicate or the predicate is an event this function 
should throw an Error.</p>

<p><strong>params</strong></p>

<ul>
<li><code>id</code>: a string which is unique, can be ignored in most case. It could be used to cache the
state of the predicate if it is difficult to decide.</li>
<li><code>predicate</code> the predicate as string like <code>"x is present"</code> </li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">isTrue: </span><span class="nf">(id, predicate) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;your predicate provider must implement itTrue&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="notifywhen">notifyWhen()</h3>

<p>The provider should call the given callback if the state of the predicate changes 
(it becomes true or false). 
The callback function takes one paramter which is the new state of the predicate. It should
be boolean <code>true</code> if the predicate changed to true, it should be boolean <code>false</code> if the predicate 
changed to false and if it is a event-predicate it should be the string `"event".
If the provider can not decide the predicate this function should throw an Error.</p>

<p><strong>params</strong></p>

<ul>
<li><code>id</code>: a string which is unique. It is to identify the requester so that the notify can be
canceled by cancelNotify giving the same id later.
state of the predicate if it is difficult to decide.</li>
<li><code>predicate</code> the predicate as string like <code>"x is present"</code> </li>
<li><code>callback</code> the callback function to call with one parameter like noted above.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">notifyWhen: </span><span class="nf">(id, predicate, callback) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;your predicate provider must implement notifyWhen&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="cancelnotify">cancelNotify()</h3>

<p>Cancels the notification for the predicate with the id given id.</p>

<p><strong>params</strong></p>

<ul>
<li><code>id</code>: The unique string that was given at <code>notifyWhen</code>.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">cancelNotify: </span><span class="nf">(id) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;your predicate provider must implement cancelNotify&quot;</span><span class="p">)</span>

<span class="nv">env = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="the-device-event-predicate-provider">The Device-Event Predicate Provider</h2>

<p>It's often the case that predicates depend on the value of a attribute of a device. If the value of
an attribute of a device changes an event is emitted that can be used to call the <code>notifyWhen</code> 
callback.</p>

<p>The <code>DeviceEventPredicateProvider</code> does handle the <code>canDecide</code>, <code>isTrue</code> and <code>cancleDecide</code>
function implementation. So there is only one function to be implemented by the sub class. This 
function is the <code>_parsePredicate</code> function witch gets the predicate to decide or notify and should
return a info object with some special keys. See the function description below for more details.</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="k">class</span> <span class="nx">DeviceEventPredicateProvider</span> <span class="k">extends</span> <span class="nx">PredicateProvider</span>
  <span class="nv">_listener: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="candecide">canDecide()</h3>

<p>Gets the info object from <code>_parsePredicate</code> implementation and checks if it returned null.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">canDecide: </span><span class="nf">(predicate) -&gt;</span>
    <span class="nv">info = </span><span class="nx">@_parsePredicate</span> <span class="nx">predicate</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">info</span><span class="o">?</span> <span class="k">then</span> <span class="s">&#39;state&#39;</span> <span class="k">else</span> <span class="kc">no</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="istrue">isTrue()</h3>

<p>Gets the info object from <code>_parsePredicate</code> implementation and calls <code>getPredicateValue()</code> on it.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">isTrue: </span><span class="nf">(id, predicate) -&gt;</span>
    <span class="nv">info = </span><span class="nx">@_parsePredicate</span> <span class="nx">predicate</span>
    <span class="k">if</span> <span class="nx">info</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">info</span><span class="p">.</span><span class="nx">getPredicateValue</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Can not decide \&quot;</span><span class="si">#{</span><span class="nx">predicate</span><span class="si">}</span><span class="s">\&quot;!&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="notifywhen">notifyWhen()</h3>

<p>Gets the <code>info</code> object from <code>_parsePredicate</code> implementation and registers an event listener 
for <code>ìnfo.event</code> at <code>info.device</code>. The event listener is obtained by calling 
<code>event.getEventListener</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">notifyWhen: </span><span class="nf">(id, predicate, callback) -&gt;</span>
    <span class="nv">info = </span><span class="nx">@_parsePredicate</span> <span class="nx">predicate</span>
    <span class="k">if</span> <span class="nx">info</span><span class="o">?</span>
      <span class="nv">device = </span><span class="nx">info</span><span class="p">.</span><span class="nx">device</span>
      <span class="nv">event = </span><span class="nx">info</span><span class="p">.</span><span class="nx">event</span>
      <span class="nv">eventListener = </span><span class="nx">info</span><span class="p">.</span><span class="nx">getEventListener</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">on</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">eventListener</span>
      <span class="nx">@_listener</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span>
        <span class="nv">id: </span><span class="nx">id</span>
        <span class="nv">destroy: </span><span class="o">=&gt;</span> <span class="nx">device</span><span class="p">.</span><span class="nx">removeListener</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">eventListener</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;DeviceEventPredicateProvider can not decide \&quot;</span><span class="si">#{</span><span class="nx">predicate</span><span class="si">}</span><span class="s">\&quot;!&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="cancelnotify">cancelNotify()</h3>

<p>Removes the notification for an with <code>notifyWhen</code> registered predicate. </p></div></div><div class="code"><div class="wrapper">  <span class="nv">cancelNotify: </span><span class="nf">(id) -&gt;</span>
    <span class="nv">listener = </span><span class="nx">@_listener</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">listener</span><span class="o">?</span>
      <span class="nx">listener</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
    <span class="k">delete</span> <span class="nx">@_listener</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-parsepredicate">_parsePredicate()</h3>

<p>The <code>_parsePredicate</code> must be implemented by the subclass. It should parse the given predicate
and return a <code>info</code> object at a match. If it does not match a predicate that the provider can
handle then <code>null</code> sould be returned. The returned info object should have the following 
properties:</p>

<ul>
<li>info.event: the event of the device which triggers the <code>notifyWhen</code> callback</li>
<li>info.device: the device where the event which triggers the <code>notifyWhen</code> callback should be 
registed</li>
<li>info.getEventListener: the event handler of the event. <code>getEventListener</code> gets the callack to
call on change as a parameter.</li>
<li>info.getPredicateValue: the function that handles <code>isTrue</code></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">_parsePredicate: </span><span class="nf">(predicate) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;Should be implemented by supper class.&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="the-switch-predicate-provider">The Switch Predicate Provider</h2>

<p>Handles predicates for the state of switch devices like:</p>

<ul>
<li><em>device</em> is on|off</li>
<li><em>device</em> is switched on|off</li>
<li><em>device</em> is turned on|off</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="k">class</span> <span class="nx">SwitchPredicateProvider</span> <span class="k">extends</span> <span class="nx">DeviceEventPredicateProvider</span>

  <span class="nv">constructor: </span><span class="nf">(_env, @framework) -&gt;</span>
    <span class="nv">env = </span><span class="nx">_env</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-parsepredicate">_parsePredicate()</h3>

<p>Parses the string and setups the info object as explained in the DeviceEventPredicateProvider.
Read the description of it to understand the return value.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_parsePredicate: </span><span class="nf">(predicate) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just to be sure convert the predicate to lower case.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">predicate = </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then try to match:</p></div></div><div class="code"><div class="wrapper">    <span class="nv">matches = </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">      ^(.+)? # the device name</span>
<span class="sr">      \s+ # followed by whitespace</span>
<span class="sr">      is # and an &quot;is&quot;</span>
<span class="sr">      \s+ # a whitespace</span>
<span class="sr">      (?:turned\s+|switched\s+)? # optional an &quot;turned &quot; or &quot;switched &quot;</span>
<span class="sr">      (on|off)$ # and ends in &quot;on&quot; or &quot;off&quot;</span>
<span class="sr">    ///</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we have a macht</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">matches</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>extract the device name</p></div></div><div class="code"><div class="wrapper">      <span class="nv">deviceName = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and state as boolean.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">state = </span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">is</span> <span class="s">&quot;on&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>For each device</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">d</span> <span class="k">of</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">devices</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the device name matches</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">matchesIdOrName</span> <span class="nx">deviceName</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and the device has a state attribute</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="s">&#39;state&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>return a info object.</p></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="nv">info =</span>
              <span class="nv">device: </span><span class="nx">d</span>
              <span class="nv">event: </span><span class="s">&#39;state&#39;</span>
              <span class="nv">getPredicateValue: </span><span class="o">=&gt;</span> 
                <span class="nx">d</span><span class="p">.</span><span class="nx">getAttributeValue</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(s) =&gt;</span> <span class="nx">s</span> <span class="o">is</span> <span class="nx">state</span>
              <span class="nv">getEventListener: </span><span class="nf">(callback) =&gt;</span> 
                <span class="k">return</span> <span class="nv">eventListener = </span><span class="nf">(s) =&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">s</span> <span class="o">is</span> <span class="nx">state</span><span class="p">)</span>
              <span class="nv">state: </span><span class="nx">state</span> <span class="c1"># for testing only</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we have no match then return null.</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="the-presence-predicate-provider">The Presence Predicate Provider</h2>

<p>Handles predicates of presence devices like</p>

<ul>
<li><em>device</em> is present</li>
<li><em>device</em> is not present</li>
<li><em>device</em> is absent</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="k">class</span> <span class="nx">PresencePredicateProvider</span> <span class="k">extends</span> <span class="nx">DeviceEventPredicateProvider</span>

  <span class="nv">constructor: </span><span class="nf">(_env, @framework) -&gt;</span>
    <span class="nv">env = </span><span class="nx">_env</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-parsepredicate">_parsePredicate()</h3>

<p>Parses the string and setups the info object as explained in the DeviceEventPredicateProvider.
Read the description of it to understand the return value.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_parsePredicate: </span><span class="nf">(predicate) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just to be sure convert the predicate to lower case.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">predicate = </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then try to match:</p></div></div><div class="code"><div class="wrapper">    <span class="nv">matches = </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">      ^(.+)? # the device name</span>
<span class="sr">      \s+ # whitespace</span>
<span class="sr">      is # is</span>
<span class="sr">      \s+ # whitespace</span>
<span class="sr">      (not\s+present|present|absent)$ # and ends with &quot;not present&quot;, &quot;present&quot; or &quot;absent&quot;</span>
<span class="sr">    ///</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we have a match</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">matches</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>extract the device name</p></div></div><div class="code"><div class="wrapper">      <span class="nv">deviceName = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and save if we should detect "present" or the opposite</p></div></div><div class="code"><div class="wrapper">      <span class="nv">negated = </span><span class="p">(</span><span class="k">if</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">isnt</span> <span class="s">&quot;present&quot;</span> <span class="k">then</span> <span class="kc">yes</span> <span class="k">else</span> <span class="kc">no</span><span class="p">)</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>For each device</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">d</span> <span class="k">of</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">devices</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check if the device name matches</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">matchesIdOrName</span> <span class="nx">deviceName</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and the device has a attribute named presence</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="s">&#39;presence&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then return a info object.</p></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="nv">info =</span>
              <span class="nv">device: </span><span class="nx">d</span>
              <span class="nv">event: </span><span class="s">&#39;presence&#39;</span>
              <span class="nv">getPredicateValue: </span><span class="o">=&gt;</span> 
                <span class="nx">d</span><span class="p">.</span><span class="nx">getAttributeValue</span><span class="p">(</span><span class="s">&#39;presence&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(presence) =&gt;</span>
                  <span class="k">if</span> <span class="nx">negated</span> <span class="k">then</span> <span class="o">not</span> <span class="nx">presence</span> <span class="k">else</span> <span class="nx">presence</span>
              <span class="nv">getEventListener: </span><span class="nf">(callback) =&gt;</span> 
                <span class="k">return</span> <span class="nv">eventListener = </span><span class="nf">(presence) =&gt;</span> 
                  <span class="nx">callback</span><span class="p">(</span><span class="k">if</span> <span class="nx">negated</span> <span class="k">then</span> <span class="o">not</span> <span class="nx">presence</span> <span class="k">else</span> <span class="nx">presence</span><span class="p">)</span>
              <span class="nv">negated: </span><span class="nx">negated</span> <span class="c1"># for testing only</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we have no match then return null.</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="the-device-attribute-predicate-provider">The Device-Attribute Predicate Provider</h2>

<p>Handles predicates for comparing device attributes like sensor value or other states:</p>

<ul>
<li><em>attribute</em> of <em>device</em> is equal to <em>value</em></li>
<li><em>attribute</em> of <em>device</em> equals <em>value</em></li>
<li><em>attribute</em> of <em>device</em> is not <em>value</em></li>
<li><em>attribute</em> of <em>device</em> is less than <em>value</em></li>
<li><em>attribute</em> of <em>device</em> is lower than <em>value</em></li>
<li><em>attribute</em> of <em>device</em> is greater than <em>value</em></li>
<li><em>attribute</em> of <em>device</em> is higher than <em>value</em></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="k">class</span> <span class="nx">DeviceAttributePredicateProvider</span> <span class="k">extends</span> <span class="nx">DeviceEventPredicateProvider</span>

  <span class="nv">constructor: </span><span class="nf">(_env, @framework) -&gt;</span>
    <span class="nv">env = </span><span class="nx">_env</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-comparevalues">_compareValues()</h3>

<p>Does the comparison.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_compareValues: </span><span class="nf">(comparator, value, referenceValue) -&gt;</span>
    <span class="k">unless</span> <span class="nb">isNaN</span> <span class="nx">value</span>
      <span class="nv">value = </span><span class="nb">parseFloat</span> <span class="nx">value</span>
    <span class="k">return</span> <span class="k">switch</span> <span class="nx">comparator</span>
      <span class="k">when</span> <span class="s">&#39;==&#39;</span> <span class="k">then</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">referenceValue</span>
      <span class="k">when</span> <span class="s">&#39;!=&#39;</span> <span class="k">then</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="nx">referenceValue</span>
      <span class="k">when</span> <span class="s">&#39;&lt;&#39;</span> <span class="k">then</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">referenceValue</span>
      <span class="k">when</span> <span class="s">&#39;&gt;&#39;</span> <span class="k">then</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="nx">referenceValue</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unknown comparator: </span><span class="si">#{</span><span class="nx">comparator</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-parsepredicate">_parsePredicate()</h3>

<p>Parses the string and setups the info object as explained in the DeviceEventPredicateProvider.
Read the description of it to understand the return value.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_parsePredicate: </span><span class="nf">(predicate) -&gt;</span>
    <span class="nv">predicate = </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="nv">matches = </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">      ^(.+)\s+ # the attribute</span>
<span class="sr">      of\s+ # of</span>
<span class="sr">      (.+?)\s+ # the device</span>
<span class="sr">      (?:is\s+)? # is</span>
<span class="sr">      (equal\s+to|equals*|lower|less|greater|is\s+not|is) </span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>is, is not, equal, equals, lower, less, greater</p></div></div><div class="code"><div class="wrapper"><span class="sr">      (?:|\s+equal|\s+than|\s+as)?\s+ # equal to, equal, than, as</span>
<span class="sr">      (.+)?$ # reference value</span>
<span class="sr">    ///</span>
    <span class="k">if</span> <span class="nx">matches</span><span class="o">?</span>
      <span class="nv">attributeName = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span>
      <span class="nv">deviceName = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span>
      <span class="nv">comparator = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span> 
      <span class="nv">referenceValue = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
      <span class="c1">#console.log &quot;#{attributeName}, #{deviceName}, #{comparator}, #{referenceValue}&quot;</span>
      <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">d</span> <span class="k">of</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">devices</span>
        <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">matchesIdOrName</span> <span class="nx">deviceName</span>
          <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="nx">attributeName</span>
            <span class="nv">comparator = </span><span class="k">switch</span> <span class="nx">comparator</span>
              <span class="k">when</span> <span class="s">&#39;is&#39;</span><span class="p">,</span> <span class="s">&#39;equal&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;equal to&#39;</span><span class="p">,</span> <span class="s">&#39;equals to&#39;</span> <span class="k">then</span> <span class="s">&#39;==&#39;</span>
              <span class="k">when</span> <span class="s">&#39;is not&#39;</span> <span class="k">then</span> <span class="s">&#39;!=&#39;</span>
              <span class="k">when</span> <span class="s">&#39;greater&#39;</span> <span class="k">then</span> <span class="s">&#39;&gt;&#39;</span>
              <span class="k">when</span> <span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="s">&#39;less&#39;</span> <span class="k">then</span> <span class="s">&#39;&lt;&#39;</span>
              <span class="k">else</span> 
                <span class="nx">env</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Illegal comparator \&quot;</span><span class="si">#{</span><span class="nx">comparator</span><span class="si">}</span><span class="s">\&quot;&quot;</span>
                <span class="kc">false</span>

            <span class="k">unless</span> <span class="nx">comparator</span> <span class="o">is</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if the attribute has a unit</p></div></div><div class="code"><div class="wrapper">              <span class="nv">unit = </span><span class="nx">d</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">].</span><span class="nx">unit</span>
              <span class="k">if</span> <span class="nx">unit</span><span class="o">?</span>
                <span class="nv">unit = </span><span class="nx">unit</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then remove it from the reference value and
allow just "c" for "°C"</p></div></div><div class="code"><div class="wrapper">                <span class="nv">lastIndex = </span><span class="nx">referenceValue</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s">&#39;°c&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">).</span><span class="nx">lastIndexOf</span> <span class="nx">unit</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s">&#39;°c&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">lastIndex</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
                  <span class="nv">referenceValue = </span><span class="nx">referenceValue</span><span class="p">.</span><span class="nx">substring</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">lastIndex</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the attribute is numerical</p></div></div><div class="code"><div class="wrapper">              <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">].</span><span class="nx">type</span> <span class="o">is</span> <span class="nb">Number</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then check the referenceValue</p></div></div><div class="code"><div class="wrapper">                <span class="k">if</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">referenceValue</span><span class="p">)</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Expected </span><span class="si">#{</span><span class="nx">referenceValue</span><span class="si">}</span><span class="s"> in \&quot;</span><span class="si">#{</span><span class="nx">predicate</span><span class="si">}</span><span class="s">\&quot; to be a number.&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and convert it to a float.</p></div></div><div class="code"><div class="wrapper">                <span class="nv">referenceValue = </span><span class="nb">parseFloat</span> <span class="nx">referenceValue</span>
              <span class="k">else</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if its not numerical but comparator is less or greater</p></div></div><div class="code"><div class="wrapper">                <span class="k">if</span> <span class="nx">comparator</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then something gone wrong.</p></div></div><div class="code"><div class="wrapper">                  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Can not compare a non numerical attribute with less or creater.&quot;</span>

              <span class="nv">lastValue = </span><span class="kc">null</span>
              <span class="k">return</span> <span class="nv">info =</span>
                <span class="nv">device: </span><span class="nx">d</span>
                <span class="nv">event: </span><span class="nx">attributeName</span>
                <span class="nv">getPredicateValue: </span><span class="o">=&gt;</span> 
                  <span class="nx">d</span><span class="p">.</span><span class="nx">getAttributeValue</span><span class="p">(</span><span class="nx">attributeName</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(value) =&gt;</span>
                    <span class="nx">@_compareValues</span> <span class="nx">comparator</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">referenceValue</span>
                <span class="nv">getEventListener: </span><span class="nf">(callback) =&gt;</span> 
                  <span class="k">return</span> <span class="nv">attributeListener = </span><span class="nf">(value) =&gt;</span>
                    <span class="nv">state = </span><span class="nx">@_compareValues</span> <span class="nx">comparator</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">referenceValue</span>
                    <span class="k">if</span> <span class="nx">state</span> <span class="o">isnt</span> <span class="nx">lastValue</span>
                      <span class="nv">lastValue = </span><span class="nx">state</span>
                      <span class="nx">callback</span> <span class="nx">state</span>
                <span class="nv">comparator: </span><span class="nx">comparator</span> <span class="c1"># for testing only</span>
                <span class="nv">attributeName: </span><span class="nx">attributeName</span> <span class="c1"># for testing only</span>
                <span class="nv">referenceValue: </span><span class="nx">referenceValue</span>
    <span class="k">return</span> <span class="kc">null</span>


<span class="nv">module.exports.PredicateProvider = </span><span class="nx">PredicateProvider</span>
<span class="nv">module.exports.PresencePredicateProvider = </span><span class="nx">PresencePredicateProvider</span>
<span class="nv">module.exports.SwitchPredicateProvider = </span><span class="nx">SwitchPredicateProvider</span>
<span class="nv">module.exports.DeviceAttributePredicateProvider = </span><span class="nx">DeviceAttributePredicateProvider</span></div></div></div></div></body></html>